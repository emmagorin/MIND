---
title: "exploratory"
output: 
  html_document:
  code_folding: hide
editor_options: 
  chunk_output_type: console
---

# Setup, load packages
```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(knitr)
```

# Load datasets, data cleaning, merges

## Load datasets
Set working directory to desktop -> local_only -> mind_study. 
I'm keeping data there so that it does not sync to dropbox, and is stored locally only instead.
All code files will be kept in dropbox directory.
```{r}
setwd("/Users/emma/Desktop/local_only/mind_study")

#ADT wide:
adt_wide_orig <- read_csv("./wide_files_2021_05_21/adt_summary2021-05-20.csv")

#ADT long:
adt_long_orig <- read_csv("./long_files_2021_05_21/adt_long2021-05-21.csv")

#Covid wide:
covid_wide_orig <- read_csv("./wide_files_2021_05_21/covid_testing_wide2021-05-20.csv")

#Covid long:
covid_long_orig <- read_csv("./long_files_2021_05_21/covid_pcr_long2021-05-21.csv")

#Micro long:
micro_long_orig <- read_csv("./long_files_2021_05_21/micro_long2021-05-20.csv")
```

## Data cleaning
Use all long datasets, do basic cleaning and tidying steps first, then merge later if needed for analyses and viz. 
One dataset per type of observation unit. 

### adt_long
Unit of observation: adt encounter. Includes admission, discharge, and transfer data
```{r}
adt_long <- adt_long_orig %>% 
  janitor::clean_names() %>% 
  select(-x1) %>% 
  rename(covid_visits_start_dt = covid_visits_start_date,
         adt_event_dt = adt_event_time,
         adt_ed_admission_dt = adt_ed_admission,
         adt_inpatient_dt = adt_inpatient,
         adt_discharge_dt = adt_discharge) %>%  # first pos pcr test or first neg pcr test if never pos in datetime format
  mutate(covid_visits_start_date = date(covid_visits_start_dt), # in date format
         adt_event_date = date(adt_event_dt),
         adt_ed_admission_date = date(adt_ed_admission_dt),
         adt_inpatient_date = date(adt_inpatient_dt),
         adt_discharge_date = date(adt_discharge_dt)) %>% 
  filter(adt_event_dt < ymd(20210301)) 
# this dataset was updated in Feb 2021, so dates later than march 2021 are errors.
# not sure how to keep this up to date once it's later in the year and these are indistinguishable from correct data.
```


### covid_long
Unit of observation: pcr test

Check: should we use covid_pcr_result or covid_pcr_result2 as the true/final result?:
```{r}
covid_long_orig %>% 
  filter(covid_pcr_result != covid_pcr_result2) %>% 
  select(covid_pcr_result, covid_pcr_result2)
```
All observations where covid_pcr_result differs from covid_pcr_result2 have
covid_pcr_reult = indeterminate and covid_pcr_result2 = positive. Use covid_pcr_result2 as the true/final result

Check: does any_pcr_pos match covid_pcr_result or covid_pcr_result2?
```{r}
#check any_pcr_pos variable
covid_wide_orig %>% 
  mutate(covid_pos = ifelse(is.na(any_pcr_pos), FALSE, TRUE)) %>% 
  summarize(sum_covid_pos = sum(covid_pos))

#check covid results variables
covid_long_orig %>% 
  mutate(covid_pcr_result1_logical = (covid_pcr_result == "Positive"),
         covid_pcr_result2_logical = (covid_pcr_result2 == "Positive")) %>% 
  group_by(mrn) %>% 
  summarize(covid_pcr_result1 = max(covid_pcr_result1_logical),
            covid_pcr_result2 = max(covid_pcr_result2_logical)) %>% 
  ungroup() %>% 
  summarize(covid_pcr_result1 = sum(covid_pcr_result1, na.rm = T), 
            covid_pcr_result2 = sum(covid_pcr_result2, na.rm = T))

#covid_pcr_result1 and covid_pcr_result2 now seem to match
```
PCR result 1 and pcr result 2 now seem to match (5/26/21)

```{r}
covid_long <- covid_long_orig %>% 
  janitor::clean_names() %>% 
  select(mrn, covid_pcr_date, covid_pcr_accession:machine) %>% 
  rename(covid_pcr_dt = covid_pcr_date) %>% 
  mutate(covid_pcr_date = date(covid_pcr_dt),
         covid_pos_logic = (covid_pcr_result2 == "Positive"))
```


### micro_long
Unit of observation: micro test
```{r}
micro_long <- micro_long_orig %>% 
  janitor::clean_names() %>% 
  select(mrn:organism_group) %>% 
  rename(admit_dt = admit_date_time,
         order_dt = order_date_time) %>% # put date time variables in consistent naming format.
  mutate(abnormal_result_logical = case_when(is.na(abnormal_result) ~ F,
                                             abnormal_result == "Y" ~ T))
```

### patients
Unit of observation: patient. 
This dataset includes 120,031 individuals for whom we have covid test information. 
Some of these people, but not all, are included in the adt dataset. All mrns in the 
adt dataset are included in the covid data, and therefore in the patients_long df created here. 
Pull patient-level data from the covid dataset, and a few other patient-level variables from the other datasets.

Additional basic info to consider for patients:
 

Check: which MRNs in the covid testing data are also in the adt data, and vice versa?
```{r}
# How many of the mrns in the covid_wide data are also in the adt_wide data?
sum(covid_wide_orig$mrn %in% adt_wide_orig$mrn)
# 88315 out of 120031 obs in the covid_wide_orig dataset are in the adt_wide_orig dataset.
# all mrns in the adt data are in the covid data.
```

Set up a few other patient-level variables to include:
```{r}
temp_deceased_hospice <- adt_long %>% 
  mutate(deceased_logical = adt_discharge_disp == "Expired",
         hospice_logical = adt_discharge_disp == "Hospice/Medical Facility",
         deceased_dt = case_when(deceased_logical == T ~ adt_discharge_dt),
         hospice_dt = case_when(hospice_logical == T ~ adt_discharge_dt)) %>% 
  group_by(mrn) %>% 
  summarize(deceased_logical = as.logical(max(deceased_logical)),
            hospice_logical = as.logical(max(hospice_logical)),
            deceased_dt = max(deceased_dt),
            hospice_dt = max(hospice_dt)) %>% 
  mutate(adt_dataset = T)

#checkpoint:
temp_deceased_hospice %>% filter(is.na(deceased_logical))

temp_covid_pos <- covid_long %>% 
  group_by(mrn) %>% 
  mutate(covid_pos_dt = case_when(covid_pos_logic == T ~ covid_pcr_dt)) %>% 
  summarize(covid_pos_ever = as.logical(max(covid_pos_logic)),
            covid_pos_dt = min(covid_pos_dt, na.rm = T)) %>% 
  mutate(covid_pos_dt = na_if(covid_pos_dt, Inf))
    
#checkpoint: covid_pos_dt should be NA if covid_pos_ever is F, and should not be NA otherwise
temp_covid_pos %>% filter(covid_pos_ever == T & is.na(covid_pos_dt))
temp_covid_pos %>% filter(covid_pos_ever == F & is.na(covid_pos_dt) == F)

temp_micro <- micro_long %>% 
  group_by(mrn) %>%
  summarize(bacterial_infection_ever = max(abnormal_result_logical)) %>% 
  mutate(micro_dataset = T)
```

Create patients dataframe.
Patients should include all mrns that we have.
adt_dataset, covid_dataset and micro_dataset variables indicate whether the mrn appears in the corresponding dataset.
```{r}
patients  <- covid_wide_orig %>% 
  janitor::clean_names() %>% 
  select(mrn, dob, sex, zipcode, 
         race, ethnicity, combined_race_ethnicity, 
         insurance_type, insurance_plan) %>% 
  mutate(covid_dataset = T) %>% 
  full_join(temp_deceased_hospice, by = "mrn") %>% 
  full_join(temp_covid_pos, by = "mrn") %>%
  full_join(temp_micro, by = "mrn") %>% 
  replace_na(list(adt_dataset = F, covid_dataset = F, micro_dataset = F))
  
rm(temp_deceased_hospice, temp_covid_pos, temp_micro) # don't need this anymore
```


## Merges and subsets

### Merge: adt_long_patients
One row per adt per patient
```{r}
adt_long_patients <- left_join(adt_long, patients, by = "mrn")
```

### Troubleshoot: discrepencies btw adt_wide and adt_long datasets:
```{r}
# mrns that are in adt_wide:
adt_wide_mrns <- adt_wide_orig %>% select(mrn)
# mrns that are in adt_long:
adt_long_mrns <- adt_long_orig %>% group_by(mrn) %>% summarize() %>% select(mrn)

# mrns that appear in adt_long but not adt_wide:
mrns_adt_long_not_wide <- setdiff(adt_long_mrns, adt_wide_mrns)
mrns_adt_long_not_wide
nrow(mrns_adt_long_not_wide)/nrow(adt_long_mrns)
# about 3% of mrns in adt_long don't appear in adt_wide

#mrns that appear in adt_wide but not adt_long:
mrns_adt_wide_not_long <- setdiff(adt_wide_mrns, adt_long_mrns)
nrow(mrns_adt_wide_not_long)/nrow(adt_wide_mrns)

# look at records of patients in adt_long but not adt_wide:
adt_long_not_wide <- left_join(mrns_adt_long_not_wide, adt_long, by = "mrn")
adt_long_not_wide %>% 
  summarize(min_dat = min(adt_event_date, na.rm = T), 
            median_date = median(adt_event_date, na.rm = T),
            max_date = max(adt_event_date, na.rm = T)
           )
# no clear date pattern on who was included in adt_wide and who was not...
```

### Merge: adt_long_micro_long_patients
Should contain one row per admission per micro test per patient.
eg, patient A has 3 adt observations (ever) * 12 micro tests (ever) = 36 observations for patient A in this dataset.
```{r}
adt_long_micro_long_patients <- adt_long %>% 
  left_join(micro_long, by = "mrn") %>% 
  left_join(patients, by = "mrn")
```


# Data Cleaning

## adt_long_patients

Add covid admission and time in hospital variables
```{r}
adt_long_patients <- adt_long_patients %>% 
  mutate(dur_covid_to_inpatient = 
           case_when(!is.na(adt_inpatient_dt) & covid_pos_ever == T ~ as.duration(adt_inpatient_dt - covid_pos_dt)),
         # dur_covid_to_admission is the time interval between the datetime of first positive PCR test and the inpatient admission datetime, for patients who ever had pos pcr test.
        covid_admission = case_when(dur_covid_to_inpatient < duration(day = 7) & dur_covid_to_inpatient > duration(day = -2) ~ T, 
                                    dur_covid_to_inpatient > duration(day = 7) ~ F,
                                    dur_covid_to_inpatient < duration(day = -2) ~ F,
                                    is.na(dur_covid_to_inpatient) ~ F),
        # covid_admission is true if the admission took place within 7 days after or 2 days before time of first positive PCR test.
        covid_inpatient_admission_dt = ifelse(covid_admission == T, adt_inpatient_dt, NA),
        # datetime of inpatient admission if it was a "covid admission"
        covid_inpatient_discharge_dt = ifelse(covid_admission == T, adt_discharge_dt, NA),
        #datetime of discharge if it was a "covid admission"
        covid_admission_time_in_hosp = case_when(covid_admission == T ~ as.duration(adt_discharge_dt - adt_inpatient_dt)))
        # covid_admission_time_in_hospital is the duration btw admission and discharge for a covid admission. 
```




Make mini dataset from micro_long data:
- one mrn per patient who has ever had an abnormal result for a bacterial infection
- type of culture
- type of pathogen?
- Date of first abnormal result, if so. NA if not. 
```{r}
micro_long_positives_only <- micro_long %>% 
  filter(abnormal_result_logical == T) #%>% # keep only if it was an abnormal result
  #group_by(mrn) %>% 
  #summarize(first_abnormal_result = min(order_dt))
```


# Quantify what data we have in each type of dataset by MRN:
Make venn diagram output outside of R
```{r}
# MRNs in each dataset:
adt_mrns <- adt_long %>% group_by(mrn) %>% summarize()
micro_mrns <- micro_long %>% group_by(mrn) %>% summarize()
covid_mrns <- covid_long %>% group_by(mrn) %>% summarize() 

# Compare MRNs in each dataset:
# N mrns that appear in all three datasets:
n_acm <- nrow(intersect(adt_mrns, intersect(covid_mrns, micro_mrns)))
# N mrns that appear in adt and covid but not micro datasets:
n_ac <- nrow(intersect(adt_mrns, covid_mrns)) - n_acm
# N mrns that appear in adt and micro but not covid datasets:
n_am <- nrow(intersect(adt_mrns, micro_mrns)) - n_acm
# N mrns that appear in covid and micro but not adt datasets:
n_cm <- nrow(intersect(covid_mrns, micro_mrns)) - n_acm
# N mrns that appear in adt dataset only:
n_a_only <- nrow(adt_mrns) - n_ac - n_am - n_acm
# N mrns that appear in covid dataset only:
n_c_only <- nrow(covid_mrns) - n_ac - n_cm - n_acm
# N mrns that appear in micro dataset only:
n_m_only <- nrow(micro_mrns) - n_am - n_cm - n_acm
# Total N mrns in ADT
n_a <- nrow(adt_mrns)
# Total N mrns in Covid
n_c <- nrow(covid_mrns)
# Total N mrns in micro
n_m <- nrow(micro_mrns)
```


# Exploratory analysis of mortality, etc:

assess missing deceased and hospice variables:
```{r}
#missing deceased
patients %>% 
  filter(is.na(deceased_logical)) %>% 
  select(mrn, deceased_logical, deceased_dt, 
          hospice_logical, hospice_dt) 
# Since patients includes everyone we have in either the adt, covid or micro datasets, deceased data will be missing for anyone not in the adt dataset.

# missing hospice
patients %>% 
  filter(is.na(hospice_logical)) %>% 
  select(mrn, hospice_logical, hospice_dt) 

patients %>% 
  filter(is.na(hospice_logical) & is.na(deceased_logical))
# Same number of mrns are missing both deceased and hospice outcomes.
```

Tabulate mortality among covid vs non-covid patients in adt dataset. Non-covid includes tested negative and never tested for covid
```{r}
patients %>% 
  group_by(covid_pos_ever) %>% 
  summarize(n = n(), 
            percent_deceased = mean(deceased_logical, na.rm = TRUE)*100, 
            percent_hospice = mean(hospice_logical, na.rm = TRUE)*100) %>% 
  kable()
```

Mortality by date of first event - covid patients
For this I looked at mortality among patients who EVER had covid by first event date listed
```{r}
# Plot encounters, deaths and hospice visits over time for covid pos patients:
adt_long_patients %>% 
  filter(covid_pos_ever == T) %>% # keep only covid pos patients
  group_by(mrn) %>% 
  summarize(first_adt_event_dt = min(adt_event_dt), # first event dt for each mrn
            deceased_logical= max(deceased_logical),
            hospice_logical = max(hospice_logical)) %>% 
  # one record per mrn of covid_pos_ever patients now
  mutate(first_adt_event_date = date(first_adt_event_dt)) %>% 
  group_by(first_adt_event_date) %>% 
  summarize(mortality_by_date = mean(deceased_logical, na.rm = TRUE), 
            first_encounters = n(),
            deaths = sum(deceased_logical),
            hospice = sum(hospice_logical)) %>% 
  pivot_longer(cols = c(first_encounters, deaths, hospice), names_to = "type", values_to = "n") %>% 
  ggplot(aes(x = first_adt_event_date)) +
  geom_line(aes(y = n, colour = type)) +
  ylim(0,250) +
  labs(x = "Date of first encounter", y = "N", title = "Encounters, deaths, and transfers to hospice care among covid patients by date of first encounter")

#mortality rate among covid patients agged by week 
adt_long_patients %>% 
  filter(covid_pos_ever == T) %>% # keep only covid pos patients
  group_by(mrn) %>% 
  summarize(first_adt_event_dt = min(adt_event_dt), # first event dt for each mrn
            deceased_logical= max(deceased_logical),
            hospice_logical = max(hospice_logical)) %>% 
  # one obs per mrn now
  mutate(date = date(first_adt_event_dt),
         week = week(first_adt_event_dt),
         year = year(first_adt_event_dt)) %>% 
  group_by(year, week) %>% 
  summarize(mean_date = mean(date), # should be mid week
            mortality_by_week = mean(deceased_logical, na.rm = TRUE)) %>% #aggregated mortality for the week
  ggplot(aes(x = mean_date)) +
  geom_line(aes(y = mortality_by_week)) +
  labs(x = "Week of first encounter", y = "Mortality", title = "Mortality among covid patients by week of first encounter")
```

Non-covid patients:
```{r}
# Plot encounters, deaths and hospice visits over time for covid neg patients:
adt_long_patients %>% 
  filter(covid_pos_ever == F) %>% 
  group_by(mrn) %>% 
  summarize(first_adt_event_dt = min(adt_event_dt), # first event dt for each mrn
            deceased_logical= max(deceased_logical),
            hospice_logical = max(hospice_logical)) %>% 
  # one record per mrn of covid_pos_ever patients now
  mutate(first_adt_event_date = date(first_adt_event_dt)) %>% 
  group_by(first_adt_event_date) %>% 
  summarize(first_encounters = n(),
            deaths = sum(deceased_logical, na.rm = T),
            hospice = sum(hospice_logical, na.rm = T)) %>% 
  pivot_longer(cols = c(first_encounters, deaths, hospice), names_to = "type", values_to = "n") %>% 
  ggplot(aes(x = first_adt_event_date)) +
  geom_line(aes(y = n, colour = type)) +
  ylim(0,650) +
  labs(x = "Date of first encounter", y = "N", title = "Encounters, deaths, and transfers to hospice care among non-covid patients by date of first encounter")

#mortality rate among covid patients agged by week 
adt_long_patients %>% 
  filter(covid_pos_ever == F) %>% 
  group_by(mrn) %>% 
  summarize(first_adt_event_dt = min(adt_event_dt), # first event dt for each mrn
            deceased_logical= max(deceased_logical),
            hospice_logical = max(hospice_logical)) %>% 
  # one obs per mrn now
  mutate(date = date(first_adt_event_dt),
         week = week(first_adt_event_dt),
         year = year(first_adt_event_dt)) %>% 
  group_by(year, week) %>% 
  summarize(mean_date = mean(date), # should be mid week
            mortality_by_week = mean(deceased_logical, na.rm = TRUE)) %>% #aggregated mortality for the week
  ggplot(aes(x = mean_date)) +
  geom_line(aes(y = mortality_by_week)) +
  labs(x = "Week of first encounter", y = "Mortality", title = "Mortality among non-covid patients by week of first encounter")
```

# Bacterial Infections among covid patients

Tabulate mortality among covid vs non-covid patients with vs without bacterial infection EVER:
```{r}
patients %>% 
  group_by(covid_pos_ever, bacterial_infection_ever) %>%
  summarize(n = n(), 
            percent_deceased = mean(deceased_logical, na.rm = TRUE)*100, 
            percent_hospice = mean(hospice_logical, na.rm = TRUE)*100) %>% 
  kable()
```


Plot mortality over time among EVER bacterial infection positive covid patients:
```{r}
adt_long_patients %>% 
  filter(covid_pos_ever == T,
         bacterial_infection_ever == T) %>% 
  group_by(mrn) %>% 
  summarize(first_adt_event_dt = min(adt_event_dt), # first event dt for each mrn
            deceased_logical= max(deceased_logical),
            hospice_logical = max(hospice_logical)) %>% 
  # one record per mrn of covid_pos_ever patients now
  mutate(first_adt_event_date = date(first_adt_event_dt)) %>% 
  group_by(first_adt_event_date) %>% 
  summarize(mortality_by_date = mean(deceased_logical, na.rm = TRUE), 
            first_encounters = n(),
            deaths = sum(deceased_logical),
            hospice = sum(hospice_logical)) %>% 
  pivot_longer(cols = c(first_encounters, deaths, hospice), names_to = "type", values_to = "n") %>% 
  ggplot(aes(x = first_adt_event_date)) +
  geom_line(aes(y = n, colour = type)) +
  ylim(0,45) +
  labs(x = "Date of first encounter", y = "N", title = "Encounters, deaths, and transfers to hospice care among covid patients by date of first encounter")

adt_long_patients %>% 
  filter(covid_pos_ever == T,
         bacterial_infection_ever == T) %>% 
  group_by(mrn) %>% 
  summarize(first_adt_event_dt = min(adt_event_dt), # first event dt for each mrn
            deceased_logical= max(deceased_logical),
            hospice_logical = max(hospice_logical)) %>% 
  # one obs per mrn now
  mutate(date = date(first_adt_event_dt),
         week = week(first_adt_event_dt),
         year = year(first_adt_event_dt)) %>% 
  group_by(year, week) %>% 
  summarize(mean_date = mean(date), # should be mid week
            mortality_by_week = mean(deceased_logical, na.rm = TRUE)) %>% #aggregated mortality for the week
  ggplot(aes(x = mean_date)) +
  geom_line(aes(y = mortality_by_week)) +
  labs(x = "Week of first encounter", y = "Mortality", title = "Mortality among non-covid patients by week of first encounter")
```


Look at whether bacterial infections took place before or after covid start time, and mortality for each group:
```{r}
micro_long %>% 
  filter(abnormal_result_logical == T) %>% # keep positives only
  left_join(patients) %>% 
  filter(covid_pos_ever == T) %>% # keep covid pos patients only
  mutate(bacterial_after_covid = 
           ifelse(covid_pos_dt <= order_dt, T, F), 
         bacterial_before_covid = 
           ifelse(covid_pos_dt >= order_dt, T, F) 
         ) %>% 
  group_by(mrn) %>% 
  summarize(deceased_logical = as.logical(max(deceased_logical)),
            hospice_logical = as.logical(max(hospice_logical)),
            bacterial_after_covid = as.logical(max(bacterial_after_covid)), 
            bacterial_before_covid = as.logical(max(bacterial_before_covid))) %>% 
  group_by(bacterial_after_covid, bacterial_before_covid) %>% 
  summarize(n = n(), mortality = mean(deceased_logical)) %>% 
  kable()

patients %>% 
  filter(covid_pos_ever == T,
         is.na(covid_pos_dt)) %>% 
  select(covid_pos_ever, covid_pos_dt)
  
# zI think this is keeping ppl who never got tested - check and correct!
```


~~~~~~~~~~~~~~~~ Where I stopped double checking code. may not run ~~~~~~~~~~~~~~~~~~

### Plot trajectories of covid patients who also had bacterial infections over time
Include: inpatient and outpatient, first covid positive pcr, first positive bacterial infection

First, let's see how many positive micro tests each person typically has:
```{r}
#adt_wide_covid_wide_micro_long: one observation per person per micro test.

# first, let's see if people generally have multiple positive micro tests:
adt_wide_covid_wide_micro_long %>% 
  filter(abnormal_result == "Y") %>% # now have one obs per adt event per positive micro test, only have ppl included with positive micro test
  group_by(mrn) %>% 
  summarize(n_abnormal_micro_tests = n(), ) %>% 
  ggplot(aes(x = n_abnormal_micro_tests)) +
  geom_density()
```

# Exploratory analysis for time in hospital

First, what type of visit was usually the first covid visit for patients who ever had a positive PCR?
```{r}
adt_long_covid_wide %>% 
  filter(any_pcr_pos == 1) %>% #produces 53,361 obs, one per encounter with any patient who has ever has a positive covid pcr test.
  filter(adt_visit ==1) %>% # keeps 11,312: only the first covid visit for each patient - may want to double check
  group_by(adt_care_level) %>% 
  summarize(n = n(), percent = round((n()/11312)*100, digits = 2)) %>% 
  kable()
```

Looks like almost all "first covid visits" were outpatient or emergency visits. Look into: how many were admitted afterwards in that same encounter?
```{r}
adt_long_covid_wide %>% 
  filter(any_pcr_pos == 1, # look at covid pos ever ONLY
         adt_visit ==1) %>% # consider only "first covid visits" for now. Should be one row per mrn
  mutate(admission_ordered_logical = ifelse(is.na(adt_inpatient), F, T)) %>%  # true if an admission was ordered in that same encounter
  group_by(adt_care_level) %>% 
  summarize(n = n(), n_admitted = sum(admission_ordered_logical), percent_admitted = round(n_admitted * 100 / n, digits = 2)) %>% 
  kable() %>% 
```

Look at the same as above, but consider anyone who was admitted within 7 days after or two days before  "first covid visit"
```{r}
admissions_summary <- adt_long_covid_wide %>% 
  filter(any_pcr_pos == 1) %>% # look at covid pos ever only
  group_by(mrn) %>% 
  summarize(covid_admission = as.logical(max(covid_admission)),
            deceased = as.logical(max(deceased)),
            covid_visit_start_date = date(max(covid_visits_start_date)),
            first_covid_inpatient_admission_date = min(covid_inpatient_admission_date), # look at first covid inpatient admission date
            first_covid_inpatient_discharge_date = min(covid_inpatient_discharge_date),
            date_of_death = max(death_datetime), # consider date of discharge with disposition "expired" to be date of death
            n_covid_admissions = sum(covid_admission),
            time_in_hospital = max(time_in_hospital)) # number of "covid admissions" to see if ppl ever are admitted, discharged, admitted again in short timeframe
  # mutate(first_covid_inpatient_admission_date = case_when(!is.na(first_covid_inpatient_admission_date) ~ date(first_covid_inpatient_admission_date)),
  #        first_covid_inpatient_discharge_date = case_when(!is.na(first_covid_inpatient_discharge_date) ~ date(first_covid_inpatient_discharge_date)),
  #        date_of_death = case_when(!is.na(date_of_death) ~ date(date_of_death)))

# might want to make this long anyway, so you can plot by date ^^^^

admissions_summary %>% 
  ungroup() %>% 
  summarize(n_covid_cases = n(),
            n_covid_admissions = sum(covid_admission),
            n_covid_deaths = sum(deceased, na.rm = T)) %>% 
  kable()

admissions_summary %>% 
  group_by(covid_visit_start_date) %>% 
  summarize(n_covid_cases = n()) %>% 
  ggplot(aes(x = covid_visit_start_date)) +
  geom_line(aes(y = n_covid_cases))

admissions_summary %>% 
  group_by(covid_visit_start_date) %>% 
  summarize(n_covid_inpatient_admissions = sum(covid_admission, na.rm = T)) %>% 
  ggplot(aes(x = covid_visit_start_date)) +
  geom_line(aes(y = n_covid_inpatient_admissions))

admissions_summary %>% 
  group_by(covid_visit_start_date) %>% 
  summarize(n_covid_deaths = sum(deceased, na.rm = T)) %>% 
  ggplot(aes(x = covid_visit_start_date)) +
  geom_line(aes(y = n_covid_deaths))

adm_summary_2 <- admissions_summary %>% 
  group_by(covid_visit_start_date) %>% 
  summarize(n_covid_cases = n(),
            n_covid_inpatient_admissions = sum(covid_admission, na.rm = T),
            n_covid_deaths = sum(deceased, na.rm = T),
            mean_time_in_hospital = mean(time_in_hospital, na.rm = T)) %>% 
  mutate(inpatient_admission_rate = n_covid_inpatient_admissions/n_covid_cases,
         mortality_rate_among_inpatient = n_covid_deaths/n_covid_inpatient_admissions)

adm_summary_2 %>% 
  ggplot(aes(x = covid_visit_start_date)) +
  geom_line(aes(y = inpatient_admission_rate))

adm_summary_2 %>% 
  ggplot(aes(x = covid_visit_start_date)) +
  geom_line(aes(y = mortality_rate_among_inpatient))

adm_summary_2 %>% 
  ungroup() %>% 
  ggplot(aes(x = covid_visit_start_date)) +
  geom_path(aes(y = mean_time_in_hospital))
         
```





What was the time in hospital for those who were admitted? (admitted during that initial encounter that we're calling "covid visit 1")
```{r}
# same start as previous question
adt_long_covid_wide %>% 
  filter(any_pcr_pos == 1, # look at covid pos ever ONLY
         adt_visit ==1) %>% # consider only "first covid visits" for now. Should be one row per mrn
  mutate(admission_ordered_logical = ifelse(is.na(adt_inpatient), F, T),
         adt_inpatient_date = date(adt_inpatient), # may want to eventually put all these in a separate cleaning step.
         adt_discharge_date = date(adt_discharge),
         ) %>% 
  filter(admission_ordered_logical == T) %>% 
  mutate(time_in_hospital = adt_discharge_date - adt_inpatient_date) %>% 
  ggplot(aes(y = time_in_hospital)) +
  geom_boxplot()

# Check for missingness:
adt_long_covid_wide %>% 
  filter(any_pcr_pos == 1, # look at covid pos ever ONLY
         adt_visit ==1) %>% # consider only "first covid visits" for now. Should be one row per mrn
  mutate(admission_ordered_logical = ifelse(is.na(adt_inpatient), F, T),
         adt_inpatient_date = date(adt_inpatient), # may want to eventually put all these in a separate cleaning step.
         adt_discharge_date = date(adt_discharge),
         ) %>% 
  filter(admission_ordered_logical == T) %>% 
  mutate(time_in_hospital = adt_discharge_date - adt_inpatient_date,
         is_na_time_in_hospital = is.na(time_in_hospital),
         is_na_discharge = is.na(adt_discharge)) %>% 
  summarize(nas = sum(is_na_time_in_hospital), na_percent = mean(is_na_time_in_hospital), na_discharge = sum(is_na_discharge))
# discharge date is missing for about 161 patients. 4% ish?

adt_long_covid_wide %>% 
  filter(any_pcr_pos == 1, # look at covid pos ever ONLY
         adt_visit ==1) %>% # consider only "first covid visits" for now. Should be one row per mrn
  mutate(admission_ordered_logical = ifelse(is.na(adt_inpatient), F, T),
         adt_inpatient_date = date(adt_inpatient), # may want to eventually put all these in a separate cleaning step.
         adt_discharge_date = date(adt_discharge),
         ) %>% 
  filter(admission_ordered_logical == T) %>% 
  mutate(time_in_hospital = adt_discharge_date - adt_inpatient_date,
         is_na_time_in_hospital = is.na(time_in_hospital),
         is_na_discharge = is.na(adt_discharge)) %>% 
  summarize(mean_time_in_hosp = mean(time_in_hospital, na.rm = T), 
            min_time_in_hosp = min(time_in_hospital, na.rm = T),
            p25_time_in_hosp = quantile(time_in_hospital, probs = .25, na.rm = T),
            median_time_in_hospital = median(time_in_hospital, na.rm = T),
            p75_time_in_hosp = quantile(time_in_hospital, probs = .75, na.rm = T),
            max_time_in_hosp = max(time_in_hospital, na.rm = T)) %>% 
  kable()
```

Look at time in hospital over time, using the same start from the previous code chunk:
```{r}
time_in_hospital_df <- adt_long_covid_wide %>% 
  filter(any_pcr_pos == 1, # look at covid pos ever ONLY
         adt_visit ==1) %>% # consider only "first covid visits" for now. Should be one row per mrn
  mutate(admission_ordered_logical = ifelse(is.na(adt_inpatient), F, T),
         adt_inpatient_date = date(adt_inpatient), # may want to eventually put all these in a separate cleaning step.
         adt_discharge_date = date(adt_discharge),
         ) %>% 
  filter(admission_ordered_logical == T) %>% 
  mutate(time_in_hospital = adt_discharge_date - adt_inpatient_date,
         is_na_time_in_hospital = is.na(time_in_hospital),
         is_na_discharge = is.na(adt_discharge)) %>% 
  group_by(adt_inpatient_date) %>% 
  summarize(median_time_in_hospital = median(time_in_hospital, na.rm = T),
            mean_time_in_hospital = mean(time_in_hospital, na.rm = T))

#median time in hosp by date of admission
time_in_hospital_df %>% 
  ggplot(aes(x = adt_inpatient_date)) +
  geom_line(aes(y = median_time_in_hospital)) +
  labs(title = "Median time in hospital by day of admission")

#median time in hosp by date of admission
time_in_hospital_df %>% 
  ggplot(aes(x = adt_inpatient_date)) +
  geom_line(aes(y = mean_time_in_hospital)) +
  labs(title = "Mean time in hospital by day of admission")
```

Let's do the same thing, but look at weekly:
```{r}
time_in_hosp_weekly <- adt_long_covid_wide %>% 
  filter(any_pcr_pos == 1, # look at covid pos ever ONLY
         adt_visit ==1) %>% # consider only "first covid visits" for now. Should be one row per mrn
  mutate(admission_ordered_logical = ifelse(is.na(adt_inpatient), F, T),
         adt_inpatient_date = date(adt_inpatient), # may want to eventually put all these in a separate cleaning step.
         adt_discharge_date = date(adt_discharge),
         ) %>% 
  filter(admission_ordered_logical == T) %>% 
  mutate(time_in_hospital = adt_discharge_date - adt_inpatient_date,
         is_na_time_in_hospital = is.na(time_in_hospital),
         is_na_discharge = is.na(adt_discharge),
         week_of_inpatient_admission = week(adt_inpatient_date)) %>% 
  group_by(week_of_inpatient_admission) %>% 
  summarize(median_time_in_hospital = median(time_in_hospital, na.rm = T),
            mean_time_in_hospital = mean(time_in_hospital, na.rm = T),
            week_inpatient_admission = mean(adt_inpatient_date)) 

time_in_hosp_weekly %>% 
  ggplot(aes(x = week_inpatient_admission)) +
  geom_line(aes(y = median_time_in_hospital)) +
  labs(title = "Median time in hospital by week of admission")

#mean: 
time_in_hosp_weekly %>% 
  ggplot(aes(x = week_inpatient_admission)) +
  geom_line(aes(y = mean_time_in_hospital)) +
  labs(title = "mean time in hospital by week of admission")


```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Should run again after here ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Add 5/10: 

First of all, do most patients have just one "covid admission"?
```{r}
adt_long_patients %>% 
  group_by(mrn) %>% 
  summarize(n_covid_admissions = sum(covid_admission)) %>% 
  ungroup() %>% 
  group_by(n_covid_admissions) %>% 
  summarize(n = n()) %>% 
  kable()
```



time in hospital violin plots for each month:
```{r}
adt_long_patients %>% 
  filter(mrn == 1000020668)

adt_long_patients %>% 
  filter(covid_admission == T) %>% # keep only "covid admissions" per our definition
  group_by(mrn) %>% 
  summarize(covid_adm_total_time_in_hosp = sum(covid_admission_time_in_hosp),
            first_covid_adm_dt = min(adt_inpatient_dt, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(covid_adm_total_time_in_hosp = covid_adm_total_time_in_hosp/86400, # turn from seconds to days manually. f lubridate
         year = year(first_covid_adm_dt),
         month = month(first_covid_adm_dt),
         y_m = paste(year, month, sep = "_"),
         y_m = factor(y_m, levels = c("2020_3", "2020_4", "2020_5", "2020_6", "2020_7", "2020_8", 
                                      "2020_9", "2020_10", "2020_11", "2020_12", "2021_1", "2021_2"))) %>% 
  group_by(y_m) %>% 
  ggplot(aes(x = y_m, y = covid_adm_total_time_in_hosp)) + 
  geom_violin(aes(fill = y_m), alpha = .5) +
  labs(title = "Total time in hospital for covid admissions by date of first covid admission",
       x = "Month of first covid admission",
       y = "Days in hospital for all covid admissions",
       legend = "Month")
```

Repeat the same graph, but for individuals who survived
```{r}
adt_long_patients %>% 
  filter(covid_admission == T, # keep only "covid admissions" per our definition
         deceased_logical == F) %>% 
  group_by(mrn) %>% 
  summarize(covid_adm_total_time_in_hosp = sum(covid_admission_time_in_hosp),
            first_covid_adm_dt = min(adt_inpatient_dt, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(covid_adm_total_time_in_hosp = covid_adm_total_time_in_hosp/86400, # turn from seconds to days manually. f lubridate
         year = year(first_covid_adm_dt),
         month = month(first_covid_adm_dt),
         y_m = paste(year, month, sep = "_"),
         y_m = factor(y_m, levels = c("2020_3", "2020_4", "2020_5", "2020_6", "2020_7", "2020_8", 
                                      "2020_9", "2020_10", "2020_11", "2020_12", "2021_1", "2021_2"))) %>% 
  group_by(y_m) %>% 
  ggplot(aes(x = y_m, y = covid_adm_total_time_in_hosp)) + 
  geom_violin(aes(fill = y_m), alpha = .5) +
  labs(title = "Total time in hospital for covid admissions among patients who survived",
       x = "Month of first covid admission",
       y = "Days in hospital for all covid admissions",
       legend = "Month")
```


# Micro data exploration

## General tabulations
Questions to consider: how do we define "the same infection" ? 
How do we define "end of infection"? 
If it's by a negative test following the last positive one, how do we know how soon after it needs to be to be testing for that purpose?

How many abnormal results did patients generally have?
(Note, this is just among patients in the micro dataset, ie, those who have ever had a micro test.)
```{r}
micro_long_positives_only %>% 
  group_by(mrn) %>% 
  summarize(n_abnormal_results = sum(abnormal_result_logical)) %>% 
  ungroup() %>% 
  ggplot(aes(x = n_abnormal_results)) +
  geom_histogram() 
```

How many unique organisms does each person have abnormal results for?
```{r}
micro_long_positives_only %>% 
  group_by(mrn) %>% 
  summarize(n_organisms = n_distinct(organism_name)) %>% 
  ggplot(aes(x = n_organisms)) +
  geom_histogram()

micro_long_positives_only %>% 
  group_by(mrn) %>% 
  summarize(n_abnormal_results = sum(abnormal_result_logical),
            n_organisms = n_distinct(organism_name)) %>% 
  group_by(n_organisms, n_abnormal_results) %>% 
  summarize(n = n()) %>% 
  pivot_wider(names_from = n_organisms, values_from = n, names_prefix = "organisms_") %>% 
  kable()
```


How many datapoints do we have for infections at different sites and species categories? 
  a: table or bar plot series disaggregated by those two things

Tabulations:
```{r}
micro_long_positives_only %>% 
  group_by(organism_name) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n))

micro_long_positives_only %>% 
  group_by(organism_name, specimen_group) %>% 
  summarize(n_cases = n()) %>% 
  ungroup() %>% 
  slice_max(n_cases, n = 10) %>% 
  kable()

# blood results only: 
micro_long_positives_only %>% 
  filter(specimen_group == "Blood") %>% 
  group_by(organism_name) %>% 
  summarize(n_cases = n()) %>% 
  ungroup() %>% 
  slice_max(n_cases, n = 10) %>% 
  kable()
```

## Length of infection

For how many of these does the person have a subsequent negative test?
Do people typically have a subsequent negative test that we could use to indicate the end of the infection?
Ideas for how to answer: summarize (or mutate, actually?) to get mrn's final abnormal dt, and then see if there's another normal infection after that.
```{r}
temp <- micro_long %>% 
  filter(specimen_group == "Blood", encounter_type == "Inpatient") %>% 
  left_join(adt_long) %>% 
    # We now have one row per micro result x adt record
  filter(order_dt > adt_inpatient_dt, order_dt < adt_discharge_dt) %>% 
    # Filter so that we have one row per micro result, with only the relevant adt admission (the one that overlaps the order date and time) attached
  group_by(mrn) %>% 
  arrange(mrn, order_dt) %>% 
  select(mrn, abnormal_result_logical, organism_name, organism_category, order_dt, adt_inpatient_dt, adt_discharge_dt, adt_visit) 
    # select relevant variables for easier viewing

view(temp)
```

Try calculating end date for infections. Start with E-Coli only
to do: somewhere here, filter for only people who have ever had ecoli.
```{r}
## ecoli_mrns contains the mrns of patients who have ever had ecoli infections in blood during inpatient stays
ecoli_mrns <- unlist(
  micro_long %>% 
  filter(specimen_group == "Blood", organism_name == "ESCHERICHIA COLI", encounter_type == "Inpatient") %>% 
    mutate(mrn = as.integer(mrn)) %>% 
  select(mrn))

## calculate end of infection for e-coli infections  
temp <- micro_long %>% 
  filter(mrn %in% ecoli_mrns, 
         specimen_group == "Blood", 
         encounter_type == "Inpatient",
         organism_name == "ESCHERICHIA COLI" | is.na(organism_name)) %>% 
          # keep e-coli and negative inpatient blood results for patients who have ever had e-coli
  left_join(adt_long) %>%  # now have one row per micro result x adt_record
  filter(order_dt > adt_inpatient_dt, order_dt < adt_discharge_dt) %>% 
          # filter so that we have one row per micro result, with only the relevant adt admission data (the one that overlaps the order date and time)
          # note, this step also means that we will only have patients who are in the adt dataset included here.
  group_by(mrn, adt_visit) %>% 
          # one group per inpatient visit per patient at this point there may be visits included without any e-coli infection
  arrange(mrn, adt_visit, order_dt) %>% 
  select(mrn, abnormal_result_logical, organism_name, organism_category, order_dt, adt_inpatient_dt, adt_discharge_dt, adt_visit) %>% 
          # arrange and select relevant variables for easier viewing
  mutate(abnormal_result_dt = case_when(abnormal_result_logical == T ~ order_dt),
         negative_result_dt = case_when(abnormal_result_logical == T ~ order_dt),
         last_abnormal_result_dt = max(abnormal_result_dt, na.rm = T)) %>% # max (last) time of abnormal result
  filter(order_dt > last_abnormal_result_dt | abnormal_result_logical == T) %>% 
          # keep if abnormal result OR if it was a negative result occurring after the final abnormal result of that inpatient stay
  summarize(first_negative_result_dt = min(negative_result_dt, na.rm = T),
            first_abnormal_result_dt = min(abnormal_result_dt, na.rm = T)) %>% 
  mutate(duration_of_infection = interval(first_negative_result_dt, first_abnormal_result_dt))

  
# still some errors - need to account for NAs

view(temp)
```

Next attempt: differentiating between multiple infections based on conversation with Anne-Catrin and Jason online.
Use positives only, since they seem to use positive tests to establish duration of bacteremia 
(rather than negative tests to check for clearance)
```{r}
micro_long_positives_only %>% 
  filter(specimen_group == "Blood", encounter_type == "Inpatient") %>% 
  left_join(adt_long) %>% # We now have one row per micro result x adt record
  filter(order_dt > adt_inpatient_dt, order_dt < adt_discharge_dt) %>% 
    # Filter so that we have one row per micro result, with only the relevant adt admission 
    # (the one that overlaps the order date and time) attached
  select(mrn, abnormal_result_logical, organism_name, organism_category, order_dt, adt_inpatient_dt, adt_discharge_dt, adt_visit) %>% 
  group_by(mrn, adt_visit, organism_name) %>% 
  arrange(mrn, adt_visit, organism_name, order_dt) %>% 
  mutate(previous_order_dt = lag(order_dt, n = 1, default = NA),
         time_since_prev_ord = as.duration(order_dt - previous_order_dt),
         time_since_category = 
           case_when(time_since_prev_ord < as.duration("7 days") ~ "less than 7",
                     time_since_prev_ord < as.duration("30 days") & time_since_prev_ord > as.duration("7 days") ~ "7 to 30",
                     time_since_prev_ord > as.duration("30 days") ~ "greater than 30")) %>% 
  ggplot(aes(x = time_since_category)) +
  geom_bar()
```













admission trajectories for covid AND bacterial infection patients:

From Sasi:

### Detection date plot for Candida
temp <- d[org.group == 'Candida', j = list(min.date = min(spec.date), max.date = max(spec.date)), by = list(is.covid, mrn, spec.group)]
temp <- orderBy(~min.date, temp)
temp$mrn = factor(temp$mrn, levels = unique(temp$mrn))
temp$spec.group = factor(temp$spec.group, levels = c('Urine', 'Blood', 'Respiratory', 'Other'))
ggplot(temp) +
  geom_errorbarh(aes(y = factor(mrn), xmin = min.date, xmax = max.date, color = is.covid)) +
  geom_point(data = d[org.group == 'Candida', j = list(spec.date, is.covid, mrn)],
             aes(y = factor(mrn), x = spec.date, color = is.covid), alpha = .5, size= .9) +
  labs(y = 'Subject id', x = 'Specimen date', title = 'Candida Specimen') +
  theme_minimal() + theme(axis.text.y = element_blank(), legend.position = 'bottom', panel.grid.major.y =  element_blank())
  
```{r}
micro_long %>% 
  filter(abnormal_result_logical == T,
         organism_name == "METHICILLIN-SUSCEPTIBLE STAPHYLOCOCCUS AUREUS") %>% 
  ggplot(aes(x = order_dt)) +
  geom_histogram()
```

  
  
  