---
title: "risk set matching analysis "
output: 
  html_document:
  code_folding: hide
editor_options: 
  chunk_output_type: console
---

# Setup, load packages
```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(knitr)
library(rsmatch)
library(survival)
library(nbpMatching)
```

```{r}
setwd("/Users/emma/Desktop/local_only/mind_study")

adt_long <- read_csv("./adt_long.csv")
adt_long_patients <- read_csv("./adt_long_patients.csv")
covid_long <- read_csv("./covid_long.csv")
micro_long <- read_csv("./micro_long.csv")
micro_long_positives_only <- read_csv("./micro_long_positives_only.csv")
patients <- read_csv("./patients.csv", col_types = cols(hospice_dt = col_datetime(format = "")))
bacterial_infections <- read_csv("./bacterial_infections.csv")
covid_admissions_bacterial <- read_csv("./covid_admissions_bacterial.csv")
```

Most of the following code is also in the mind_exploratory rmd file. Revisit questions about how many covid admissions each patient has and how many bacterial infections each patient has occuring during covid admissions:
```{r}
# how many "covid admissions" does each patient have?
adt_long_patients %>% 
  group_by(mrn) %>% 
  summarize(n_covid_admissions = sum(covid_admission)) %>% 
  ungroup() %>% 
  group_by(n_covid_admissions) %>% 
  summarize(n = n()) %>% 
  kable()

# How many infections did each covid patient have that occurred during covid inpatient admissions?
covid_admissions_bacterial %>% 
  group_by(mrn) %>% 
  summarize(n_bacterial_infections = sum(bacterial_infection)) %>% 
  ungroup() %>%  group_by(n_bacterial_infections) %>% 
  summarize(n = n()) %>% 
  kable()
    # >1 means multiple infections 

# How many unique mrns are there?
covid_admissions_bacterial %>%  count(mrn)

# examine details of covid admissions for patients with multiple covid admissions:
adt_long_patients %>% 
  group_by(mrn) %>% 
  mutate(n_covid_admissions = sum(covid_admission)) %>% 
  filter(n_covid_admissions > 1,
         covid_admission == T) %>% 
  select(mrn, adt_inpatient_dt, adt_discharge_dt, adt_site, adt_care_level, adt_discharge_disp) %>% 
  view()
```
It seems that these multiple inpatients stays either have to do with transfer to a different care level (ICU, hospice, etc), 
or with multiple stays that are initiated by emergency room visits with the week following covid diagnosis.
I may want to look for transfers to ICU care that happen later in the trajectory for patients with covid admissions - 
ie, if they were admitted and then transferred and the transfer shows up as a different line.

Try the example given with the rsmatch package:
```{r}
df <- data.frame(
  hhidpn = rep(1:3, each = 3),
  wave = rep(1:3, 3),
  treatment_time = rep(c(2,3,NA), each = 3),
  X1 = c(2,2,2,3,3,3,9,9,9),
  X2 = rep(c("a","a","b"), each = 3),
  X3 = c(9,4,5,6,7,2,3,4,8),
  X4 = c(8,9,4,5,6,7,2,3,4)
)

if (requireNamespace("survival", quietly = TRUE) &
    requireNamespace("nbpMatching", quietly = TRUE)) {
  example_pairs <- coxpsmatch(n_pairs = 1, data = df, id = "hhidpn", time = "wave", trt_time = "treatment_time")
}
```

Set up data for matching:
```{r}
matching_df <- covid_admissions_bacterial %>% 
  group_by(mrn) %>% 
  mutate(first_inpatient_dt = min(adt_inpatient_dt),
         last_discharge_dt = max(adt_discharge_dt),
         covid_time_in_hospital = last_discharge_dt - first_inpatient_dt,
         covid_days_in_hospital = covid_time_in_hospital / ddays(1),
         first_bacterial_start_dt = min(first_dt, na.rm = T),
         age_at_admission = as.numeric((as_date(first_inpatient_dt) - as_date(dob))/365),
         bacterial_infection_ever = replace_na(bacterial_infection_ever, 0),
         bacterial_infection_ever = as.logical(bacterial_infection_ever),
         covid_and_bacterial_same_admission = replace_na(covid_and_bacterial_same_admission, F), 
         trt_time = case_when(!(first_bacterial_start_dt == Inf) ~ as.numeric(((first_bacterial_start_dt) - (first_inpatient_dt)) / ddays(1)))) %>% 
  select(mrn, trt_time, covid_days_in_hospital, first_dt, first_bacterial_start_dt, everything()) %>% 
  group_by(mrn) %>% arrange(mrn, first_dt) %>% mutate(index = row_number()) %>% 
    # index sets it up for us to choose just one row per mrn (with info for the first infection)
    # This gets rid of duplicate rows per mrn because of duplicate admissions or duplicate bacterial infections
  filter(index == 1)
  
  filter(first_inpatient_dt == adt_inpatient_dt) %>% # gets rid of duplicate rows per mrn because of duplicate admissions
  filter(covid_and_bacterial_same_admission == F | first_bacterial_start_dt == first_dt) %>%  # gets rid of duplicate rows per mrn because of duplicate bacterial infections
  arrange(mrn, first_dt) %>% 
  
    # keep only one obs per patient, using the first observation so that for the moment we're considering covars at baseline (not time varying)

matching_df %>% 
  group_by(mrn) %>% 
  mutate(n = n()) %>% 
  filter(n > 1) %>% 
  view()
```

Run matching procedure:
```{r}
pairs <- coxpsmatch()
```

